#!/bin/bash

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ–ø–ª–æ–π Telegram –±–æ—Ç–∞ –Ω–∞ DigitalOcean
# –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ —Å–∏—Å—Ç–µ–º—ã

set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–µ–ø–ª–æ–π –±–æ—Ç–∞..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
echo "üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É..."
ssh -i ~/.ssh/do_key root@159.223.0.234 "echo '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —É—Å–ø–µ—à–Ω–æ'"

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±–æ—Ç–∞
echo "üìÅ –°–æ–∑–¥–∞–µ–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
ssh -i ~/.ssh/do_key root@159.223.0.234 "mkdir -p /opt/telegram-bots/maps-to-waze-bot/data"

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
echo "üì¶ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –±–æ—Ç–∞..."
scp -i ~/.ssh/do_key -r . root@159.223.0.234:/opt/telegram-bots/maps-to-waze-bot/

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "üîê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
ssh -i ~/.ssh/do_key root@159.223.0.234 "cd /opt/telegram-bots/maps-to-waze-bot && chown -R telegram-bot:telegram-bot . && chmod +x deploy.sh"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
ssh -i ~/.ssh/do_key root@159.223.0.234 "cd /opt/telegram-bots/maps-to-waze-bot && docker-compose down || true"

# –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo "üê≥ –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
ssh -i ~/.ssh/do_key root@159.223.0.234 "cd /opt/telegram-bots/maps-to-waze-bot && docker-compose up -d --build"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞..."
ssh -i ~/.ssh/do_key root@159.223.0.234 "cd /opt/telegram-bots/maps-to-waze-bot && docker-compose ps"

echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω! –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ."
echo "üìä –õ–æ–≥–∏: docker-compose logs -f maps-to-waze-bot"
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞: docker-compose down" 